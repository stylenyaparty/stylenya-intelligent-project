generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  passwordHash String
}

model Product {
  id                String   @id @default(uuid())
  name              String
  productSource     ProductSource
  productType       String
  status            ProductStatus @default(ACTIVE)
  seasonality       Seasonality   @default(NONE)

  shopifyProductId  String?
  etsyListingId     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  salesRecords      SalesRecord[]
  requests          Request[]

  decisions Decision[]
}

model SalesRecord {
  id             String      @id @default(uuid())
  productId      String
  product        Product     @relation(fields: [productId], references: [id])

  salesPeriod    SalesPeriod
  unitsSold      Int
  revenueAmount  Decimal

  asOfDate       DateTime
  createdAt      DateTime @default(now())
}

model Request {
  id          String        @id @default(uuid())
  channel     RequestChannel
  theme       String
  productType String?
  status      RequestStatus @default(NEW)

  productId   String?
  product     Product?     @relation(fields: [productId], references: [id])

  createdAt   DateTime @default(now())
}

model Settings {
  id                              Int     @id @default(1)
  boostSalesThresholdD90          Int     @default(10)
  retireSalesThresholdD180        Int     @default(2)
  requestThemePriorityThreshold   Int     @default(3)
  defaultCurrency                 String  @default("USD")

  updatedAt DateTime @updatedAt
}

model DecisionLog {
  id           String   @id @default(uuid())
  weekStart    DateTime
  engineVersion String  @default("v1")

  // snapshot JSON de items (WeeklyFocusItem[])
  itemsJson     Json

  createdAt     DateTime @default(now())

  @@unique([weekStart, engineVersion])
  @@index([weekStart])
}

model Decision {
  id             String   @id @default(uuid())

  decisionType   DecisionType
  status         DecisionStatus @default(PLANNED)

  // Target (por ahora solo PRODUCT; luego ampliamos a THEME/COLLECTION si quieres)
  productId      String
  product        Product  @relation(fields: [productId], references: [id])

  rationale      String
  expectedImpact String?

  // Opcional: guardar la recomendaci√≥n del engine al momento de decidir
  engineVersion  String   @default("v1")
  engineSnapshot Json?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([createdAt])
  @@index([decisionType, status])
  @@index([productId])
}

model KeywordSeed {
  id        String           @id @default(cuid())
  term      String           @unique
  source    KeywordSeedSource
  status    KeywordSeedStatus @default(ACTIVE)
  tagsJson  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([term])
}

model KeywordJob {
  id          String           @id @default(cuid())
  mode        KeywordJobMode
  marketplace KeywordMarketplace
  language    String
  engine      String
  country     String
  niche       String           @default("party decorations")
  topic       String?
  maxResults  Int              @default(10)
  providerUsed String
  paramsJson  Json
  status      KeywordJobStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  items KeywordJobItem[]
}

model KeywordJobItem {
  id         String              @id @default(cuid())
  jobId      String
  job        KeywordJob          @relation(fields: [jobId], references: [id])
  term       String
  source     KeywordJobItemSource
  status     KeywordJobItemStatus @default(PENDING)
  resultJson Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  promotedSignal PromotedKeywordSignal?

  @@index([jobId])
  @@index([term])
  @@unique([jobId, term])
}

model PromotedKeywordSignal {
  id               String          @id @default(cuid())
  keyword          String
  jobItemId        String          @unique
  jobItem          KeywordJobItem  @relation(fields: [jobItemId], references: [id])
  engine           String
  language         String
  country          String
  interestScore    Int?
  competitionScore Int?
  priority         KeywordPriority @default(HIGH)
  promotedAt       DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([keyword, engine, language, country])
  @@index([keyword])
  @@index([promotedAt])
}

enum UserRole {
  ADMIN
  USER
}

enum ProductSource {
  ETSY
  SHOPIFY
  BOTH
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

enum Seasonality {
  NONE
  VALENTINES
  EASTER
  BACK_TO_SCHOOL
  HALLOWEEN
  CHRISTMAS
  CUSTOM
}

enum SalesPeriod {
  D30
  D90
  D180
  D365
}

enum RequestChannel {
  WHATSAPP
  FORM
  MANUAL
}

enum RequestStatus {
  NEW
  REVIEWED
  FULFILLED
  DISMISSED
}

enum DecisionTargetType {
  PRODUCT
  THEME
}

enum DecisionType {
  MIGRATE
  BOOST
  KEEP
  PAUSE
  RETIRE
  LAUNCH
  PROMOTE
}

enum DecisionStatus {
  PLANNED
  EXECUTED
  MEASURED
  CANCELLED
}

enum KeywordSeedSource {
  CUSTOM
  AUTO
}

enum KeywordSeedStatus {
  ACTIVE
  ARCHIVED
}

enum KeywordJobMode {
  CUSTOM
  AUTO
  HYBRID
  AI
}

enum KeywordMarketplace {
  ETSY
  SHOPIFY
  GOOGLE
}

enum KeywordJobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum KeywordJobItemSource {
  CUSTOM
  AUTO
  HYBRID
  AI
}

enum KeywordJobItemStatus {
  PENDING
  DONE
  FAILED
}

enum KeywordPriority {
  LOW
  MED
  HIGH
}
