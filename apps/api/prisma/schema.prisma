generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  passwordHash String
}

model Product {
  id                String   @id @default(uuid())
  name              String
  productSource     ProductSource
  productType       String
  status            ProductStatus @default(ACTIVE)
  seasonality       Seasonality   @default(NONE)

  shopifyProductId  String?
  etsyListingId     String?
  archivedAt        DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  salesRecords      SalesRecord[]
  requests          Request[]

  @@index([archivedAt])
}

model SalesRecord {
  id             String      @id @default(uuid())
  productId      String
  product        Product     @relation(fields: [productId], references: [id])

  salesPeriod    SalesPeriod
  unitsSold      Int
  revenueAmount  Decimal

  asOfDate       DateTime
  createdAt      DateTime @default(now())
}

model Request {
  id          String        @id @default(uuid())
  channel     RequestChannel
  theme       String
  productType String?
  status      RequestStatus @default(NEW)

  productId   String?
  product     Product?     @relation(fields: [productId], references: [id])

  createdAt   DateTime @default(now())
}

model Settings {
  id                              Int     @id @default(1)
  boostSalesThresholdD90          Int     @default(10)
  retireSalesThresholdD180        Int     @default(2)
  requestThemePriorityThreshold   Int     @default(3)
  defaultCurrency                 String  @default("USD")
  googleAdsEnabled                Boolean @default(false)
  googleAdsCustomerId             String?
  googleAdsDeveloperToken         String?
  googleAdsClientId               String?
  googleAdsClientSecret           String?
  googleAdsRefreshToken           String?

  updatedAt DateTime @updatedAt
}

model DecisionLog {
  id           String   @id @default(uuid())
  weekStart    DateTime
  engineVersion String  @default("v1")

  // snapshot JSON de items (WeeklyFocusItem[])
  itemsJson     Json

  createdAt     DateTime @default(now())

  @@unique([weekStart, engineVersion])
  @@index([weekStart])
}

model Decision {
  id            String   @id @default(uuid())
  status        DecisionStatus @default(PLANNED)

  actionType    String
  targetType    DecisionTargetType?
  targetId      String?
  dedupeKey     String   @unique
  title         String
  rationale     String?
  priorityScore Int?
  sources       Json?

  promotedDraft DecisionDraft?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([createdAt])
  @@index([status])
  @@index([actionType])
}

model KeywordSeed {
  id        String           @id @default(cuid())
  term      String           @unique
  source    KeywordSeedSource
  kind      KeywordSeedKind  @default(INCLUDE)
  status    KeywordSeedStatus @default(ACTIVE)
  tagsJson  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([term])
  @@index([kind, status])
}

model ProductTypeDefinition {
  id           String   @id @default(cuid())
  key          String   @unique
  label        String
  synonymsJson Json?
  required     Boolean  @default(false)
  status       ProductTypeStatus @default(ACTIVE)
  tagsJson     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status])
}

model SignalBatch {
  id              String   @id @default(cuid())
  source          String
  filename        String?
  status          String
  totalRows       Int      @default(0)
  importedRows    Int      @default(0)
  skippedRows     Int      @default(0)
  columnsDetected Json?
  warningsJson    Json?
  uploadedAt      DateTime @default(now())
  createdAt       DateTime @default(now())

  signals         KeywordSignal[]
}

model KeywordSignal {
  id                 String      @id @default(cuid())
  batchId            String
  batch              SignalBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  keyword            String
  keywordNormalized  String
  source             String
  geo                String?
  language           String?

  avgMonthlySearches Int?
  competitionLevel   String?
  competitionIndex   Float?
  cpcLow             Float?
  cpcHigh            Float?
  change3mPct        Float?
  changeYoYPct       Float?
  currency           String?
  score              Float       @default(0)
  scoreReasons       String?
  monthlySearchesJson Json?
  rawRowHash         String?
  rawRow             Json?

  createdAt          DateTime @default(now())

  @@index([keywordNormalized])
  @@index([source, createdAt])
  @@unique([batchId, keywordNormalized])
}

model KeywordJob {
  id          String           @id @default(cuid())
  mode        KeywordJobMode
  marketplace KeywordMarketplace
  language    String
  engine      String
  country     String
  niche       String           @default("")
  maxResults  Int              @default(10)
  providerUsed String
  providerRequest Json?
  paramsJson  Json
  status      KeywordJobStatus @default(PENDING)
  archivedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  items KeywordJobItem[]

  @@index([archivedAt])
}

model KeywordJobItem {
  id         String              @id @default(cuid())
  jobId      String
  job        KeywordJob          @relation(fields: [jobId], references: [id])
  term       String
  source     KeywordJobItemSource
  status     KeywordJobItemStatus @default(PENDING)
  resultJson Json?
  providerRaw Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  promotedSignal PromotedKeywordSignal?

  @@index([jobId])
  @@index([term])
  @@unique([jobId, term])
}

model PromotedKeywordSignal {
  id               String          @id @default(cuid())
  keyword          String
  jobItemId        String          @unique
  jobItem          KeywordJobItem  @relation(fields: [jobItemId], references: [id])
  engine           String
  language         String
  country          String
  interestScore    Int?
  competitionScore Int?
  priority         KeywordPriority @default(HIGH)
  promotedAt       DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([keyword, engine, language, country])
  @@index([keyword])
  @@index([promotedAt])
}

model WeeklyFocus {
  id        String   @id @default(cuid())
  asOf      DateTime
  limit     Int
  itemsJson Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([asOf])
}

model DecisionDraft {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  createdDate        DateTime
  status             DecisionDraftStatus @default(NEW)
  title              String
  whyNow             String              @map("rationale")
  riskNotes          String
  nextSteps          Json                @map("recommendedActions")
  keywords           Json
  confidence         Float?
  signalIds          Json
  seedSet            Json?
  model              String?
  usage              Json?
  payloadSnapshot    Json?
  sourceBatchId      String?
  lastExpandedAt     DateTime?
  expansionsCount    Int                 @default(0)
  promotedDecisionId String?             @unique
  promotedDecision   Decision?           @relation(fields: [promotedDecisionId], references: [id])
  expansions         DecisionDraftExpansion[]

  @@index([createdDate])
  @@index([status])
}

model DecisionDraftExpansion {
  id            String              @id @default(cuid())
  draftId       String
  kind          DraftExpansionKind  @default(EXPAND)
  focus         String?
  promptSnapshot Json
  responseJson  Json
  responseRaw   String?
  model         String?
  provider      String?
  tokensIn      Int?
  tokensOut     Int?
  latencyMs     Int?
  createdAt     DateTime @default(now())

  draft DecisionDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId, createdAt])
}

model DecisionLogEvent {
  id        String               @id @default(cuid())
  eventType DecisionLogEventType
  refType   String
  refId     String
  metaJson  Json?
  createdAt DateTime @default(now())

  @@index([eventType, createdAt])
  @@index([refType, refId])
}

enum UserRole {
  ADMIN
  USER
}

enum ProductSource {
  ETSY
  SHOPIFY
  BOTH
}

enum ProductStatus {
  ACTIVE
  DRAFT
  ARCHIVED
}

enum Seasonality {
  NONE
  VALENTINES
  EASTER
  BACK_TO_SCHOOL
  HALLOWEEN
  CHRISTMAS
  CUSTOM
}

enum SalesPeriod {
  D30
  D90
  D180
  D365
}

enum RequestChannel {
  WHATSAPP
  FORM
  MANUAL
}

enum RequestStatus {
  NEW
  REVIEWED
  FULFILLED
  DISMISSED
}

enum DecisionTargetType {
  KEYWORD
  PRODUCT
  THEME
}

enum DecisionStatus {
  PLANNED
  EXECUTED
  MEASURED
  CANCELLED
}

enum KeywordSeedSource {
  CUSTOM
  AUTO
}

enum KeywordSeedKind {
  INCLUDE
  EXCLUDE
}

enum KeywordSeedStatus {
  ACTIVE
  ARCHIVED
}

enum ProductTypeStatus {
  ACTIVE
  ARCHIVED
}

enum KeywordJobMode {
  CUSTOM
  AUTO
  HYBRID
}

enum KeywordMarketplace {
  ETSY
  SHOPIFY
  GOOGLE
}

enum KeywordJobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum KeywordJobItemSource {
  CUSTOM
  AUTO
  HYBRID
}

enum DecisionDraftStatus {
  NEW
  DISMISSED
  PROMOTED
}

enum DraftExpansionKind {
  EXPAND
  REFORMULATE
  RERUN
}

enum DecisionLogEventType {
  DRAFT_CREATED
  DRAFT_EXPANDED
  DRAFT_REFORMULATED
  DRAFT_RERUN
  DRAFT_PROMOTED
  DRAFT_DISMISSED
}

enum KeywordJobItemStatus {
  PENDING
  DONE
  FAILED
}

enum KeywordPriority {
  LOW
  MED
  HIGH
}
