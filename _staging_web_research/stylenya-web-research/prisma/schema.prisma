generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

model WebResearchRun {
  id         String            @id @default(cuid())
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  status     WebResearchStatus @default(QUEUED)
  mode       ResearchMode      @default(quick)
  query      String
  locale     String?
  geo        String?
  language   String?
  seedJson   Json?
  timingsMs  Json?
  errorJson  Json?
  resultJson Json?
  clusters   ResearchCluster[]
  rows       ResearchRow[]

  @@index([createdAt])
  @@index([status])
  @@index([mode])
}

model ResearchRow {
  id          String             @id @default(cuid())
  runId       String
  createdAt   DateTime           @default(now())
  url         String
  title       String
  snippet     String?
  publishedAt DateTime?
  score       Float?
  clusterKey  String?
  clusterRank Int?
  rawJson     Json?
  evidences   ResearchEvidence[]
  run         WebResearchRun     @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, url])
  @@index([runId])
  @@index([publishedAt])
  @@index([score])
}

model ResearchCluster {
  id         String         @id @default(cuid())
  runId      String
  createdAt  DateTime       @default(now())
  key        String
  label      String
  summary    String?
  rank       Int?
  rowCount   Int            @default(0)
  topScore   Float?
  bundleJson Json?
  run        WebResearchRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, key])
  @@index([runId])
}

model ResearchEvidence {
  id          String      @id @default(cuid())
  rowId       String
  createdAt   DateTime    @default(now())
  url         String
  title       String?
  snippet     String?
  publishedAt DateTime?
  source      String?
  rawJson     Json?
  row         ResearchRow @relation(fields: [rowId], references: [id], onDelete: Cascade)

  @@unique([rowId, url])
  @@index([rowId])
}

enum WebResearchStatus {
  QUEUED
  RUNNING
  SUCCESS
  PARTIAL
  FAILED
}

enum ResearchMode {
  quick
  deep
}
